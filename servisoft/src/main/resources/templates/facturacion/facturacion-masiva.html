<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/template :: head}">
    <meta charset="UTF-8">
    <title>Facturación Masiva</title>
</head>

<body class="d-flex flex-column min-vh-100">

    <header th:replace="~{fragments/template :: navbar}"></header>

    <main class="flex-fill">
        <div class="container my-5">

            <h2 class="mb-4 text-purple-dark">Facturación Masiva</h2>

            <!--MENSAJE DE ERROR-->
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Error:</strong> <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>

            <!--MENSAJE DE EXITO-->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <strong>¡Éxito!</strong> <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>

            <!--CARTA-->
            <div class="card shadow-2-strong">
                <div class="card-body p-4 p-md-5">

                    <!-- FORMULARIO DE PROCESAMIENTO -->
                    <form id="formFacturacionMasiva" th:action="@{/facturacion/procesar/masiva}" th:object="${facturaForm}" method="POST" class="mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-12 col-md-6">
                                <label for="periodo" class="form-label fw-bold">Selecciona el Período<span class="text-danger">*</span></label>
                                <select th:field="*{periodo}" class="form-select" id="periodo" required>
                                    <option value="">-- Selecciona una periodicidad --</option>
                                    <option th:each="p : ${Periodicidad}" th:value="${p}" th:text="${p}"></option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6">
                                <button type="button" id="btnProcesarFacturacion" class="btn btn-purple w-100" data-mdb-ripple-init>
                                    <i class="fas fa-bolt me-2"></i>Procesar Facturación
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted d-block mt-2">
                            Se procesarán todas las cuentas activas con servicios pendientes utilizando la cantidad de preferencia establecida.
                        </small>
                    </form>

                    <hr class="my-4">

                    <!-- TABLA DE HISTORIAL -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-purple-dark">
                                <tr>
                                    <th scope="col">Fecha Emisión</th>
                                    <th scope="col" class="text-end">Cantidad de Facturas</th>
                                    <th scope="col" class="text-end">Monto Total</th>
                                    <th scope="col" class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="facturacionMasiva : ${paginaDeFacturasMasivas.content}">
                                    <td th:text="${#temporals.format(facturacionMasiva.fechaEmision, 'dd/MM/yyyy')}">
                                        01/01/2025</td>
                                    <td class="text-end">
                                        <span class="badge bg-purple-dark" th:text="${facturacionMasiva.cantidadDeFacturas}">0</span>
                                    </td>
                                    <td class="text-end"
                                        th:text="'$' + ${#numbers.formatDecimal(facturacionMasiva.montoTotal, 1, 'POINT', 2, 'COMMA')}">
                                        $0.00
                                    </td>
                                    <td class="text-center">
                                        <a th:href="@{/facturacion/masiva/{id}(id=${facturacionMasiva.idFacturacionMasiva})}"
                                            class="btn btn-purple btn-sm" data-mdb-ripple-init>
                                            <i class="fas fa-eye me-1"></i>Detalles
                                        </a>
                                    </td>
                                </tr>

                                <tr th:if="${paginaDeFacturasMasivas.empty}">
                                    <td colspan="4" class="text-center text-muted p-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No hay facturaciones masivas registradas aún.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- PAGINACIÓN -->
                    <nav th:if="${paginaDeFacturasMasivas.totalPages > 1}" aria-label="Paginación" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${paginaDeFacturasMasivas.first} ? 'disabled'">
                                <a class="page-link" th:href="@{/facturacion/masiva(page=${paginaDeFacturasMasivas.number - 1})}"
                                    th:if="${not paginaDeFacturasMasivas.first}">
                                    <i class="fas fa-chevron-left me-1"></i>Anterior
                                </a>
                                <span class="page-link" th:if="${paginaDeFacturasMasivas.first}">
                                    <i class="fas fa-chevron-left me-1"></i>Anterior
                                </span>
                            </li>

                            <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, paginaDeFacturasMasivas.totalPages - 1)}"
                                th:classappend="${pageNum == paginaDeFacturasMasivas.number} ? 'active'">
                                <a class="page-link" th:href="@{/facturacion/masiva(page=${pageNum})}"
                                    th:text="${pageNum + 1}"></a>
                            </li>

                            <li class="page-item" th:classappend="${paginaDeFacturasMasivas.last} ? 'disabled'">
                                <a class="page-link" th:href="@{/facturacion/masiva(page=${paginaDeFacturasMasivas.number + 1})}"
                                    th:if="${not paginaDeFacturasMasivas.last}">
                                    Siguiente<i class="fas fa-chevron-right ms-1"></i>
                                </a>
                                <span class="page-link" th:if="${paginaDeFacturasMasivas.last}">
                                    Siguiente<i class="fas fa-chevron-right ms-1"></i>
                                </span>
                            </li>
                        </ul>
                    </nav>

                </div>
            </div>

        </div>
    </main>

    <footer th:replace="~{fragments/template :: footer}"></footer>

    <div th:replace="~{fragments/template :: scripts}"></div>

    <!-- MODAL CONFIRMACIÓN FACTURACIÓN MASIVA -->
    <div id="modalFacturacionMasiva" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:8px; padding:30px; width:90%; max-width:500px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
            <h5 style="margin-bottom:20px; color:#333;">
                <i class="fas fa-exclamation-triangle" style="color:#ffc107;"></i> Confirmación de Facturación Masiva
            </h5>
            
            <div style="background:#fff3cd; border:1px solid #ffc107; border-radius:4px; padding:15px; margin-bottom:15px;">
                <i class="fas fa-info-circle" style="color:#ff6b6b;"></i>
                <strong style="color:#666;">Esta acción procesará la facturación de todas las cuentas activas.</strong>
            </div>

            <div style="margin-bottom:15px; padding:15px; background:#f8f9fa; border-radius:4px;">
                <p style="margin:0 0 10px 0; color:#666;">
                    Se facturarán todos los servicios pendientes utilizando la <strong>cantidad de preferencia</strong> establecida en la gestión de cuentas.
                </p>
                <p style="margin:10px 0; color:#666;">
                    <strong>Período seleccionado:</strong> <span id="periodoMasiva" style="background:#e7f3ff; padding:2px 8px; border-radius:3px; color:#0066cc;"></span>
                </p>
                <p style="margin:0; color:#999; font-size:12px;">
                    <i class="fas fa-shield-alt"></i> Esta operación es transaccional. Si ocurre un error, se revertirán todos los cambios.
                </p>
            </div>

            <div style="margin-top:25px; display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="cerrarFacturacionMasiva()" style="padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button onclick="confirmarFacturacionMasiva()" style="padding:10px 20px; background:#6f42c1; color:white; border:none; border-radius:4px; cursor:pointer;">
                    <i class="fas fa-check"></i> Aceptar y Procesar
                </button>
            </div>
        </div>
    </div>

    <script>
        function abrirFacturacionMasiva(button) {
            const periodo = document.getElementById('periodo').value;

            if (!periodo) {
                alert('Por favor selecciona un período antes de procesar.');
                return;
            }

            const textoOption = document.getElementById('periodo').options[document.getElementById('periodo').selectedIndex].text;
            document.getElementById('periodoMasiva').textContent = textoOption;
            
            document.getElementById('modalFacturacionMasiva').style.display = 'flex';
        }

        function cerrarFacturacionMasiva() {
            document.getElementById('modalFacturacionMasiva').style.display = 'none';
        }

        function confirmarFacturacionMasiva() {
            document.getElementById('formFacturacionMasiva').submit();
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                cerrarFacturacionMasiva();
            }
        });

        // Conectar botón con función
        document.addEventListener('DOMContentLoaded', function() {
            const btnProcesar = document.getElementById('btnProcesarFacturacion');
            if (btnProcesar) {
                btnProcesar.onclick = abrirFacturacionMasiva;
            }
        });
    </script>

</body>

</html>
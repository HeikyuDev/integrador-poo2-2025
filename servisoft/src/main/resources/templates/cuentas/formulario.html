<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/template :: head}"></head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<body class="d-flex flex-column min-vh-100">
    <header th:replace="~{fragments/template :: navbar}"></header>

    <main class="flex-fill">
        <div class="container my-5">
            <!-- Encabezado -->
            <div class="mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-wallet me-2 text-primary"></i>
                    <span th:text="${cuenta != null ? 'Editar Cuenta' : 'Nueva Cuenta'}"></span>
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/cuentas}">Cuentas</a></li>
                        <li class="breadcrumb-item active" 
                            th:text="${cuenta != null ? 'Editar' : 'Nueva'}"></li>
                    </ol>
                </nav>
            </div>

            <div class="row">
                <!-- Formulario Principal -->
                <div class="col-lg-8">
                    <div class="card shadow-4 mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Información de la Cuenta
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="formCuenta">
                                <!-- Cliente -->
                                <div class="mb-3">
                                    <label for="cliente" class="form-label">
                                        <i class="fas fa-user me-2"></i>Cliente *
                                    </label>
                                    <select class="form-select" id="cliente" name="idCliente" required
                                            th:disabled="${cuenta != null}">
                                        <option value="">Seleccione un cliente...</option>
                                        <option th:each="cliente : ${clientes}" 
                                                th:value="${cliente.idCliente}"
                                                th:text="${cliente.nombre}"
                                                th:selected="${cuenta != null && cuenta.cliente.idCliente == cliente.idCliente}">
                                        </option>
                                    </select>
                                    <small class="text-muted" th:if="${cuenta != null}">
                                        No se puede cambiar el cliente de una cuenta existente
                                    </small>
                                </div>

                                <!-- Razón Social -->
                                <div class="mb-3">
                                    <label for="razonSocial" class="form-label">
                                        <i class="fas fa-building me-2"></i>Razón Social *
                                    </label>
                                    <input type="text" class="form-control" id="razonSocial" 
                                           name="razonSocial" required maxlength="100"
                                           th:value="${cuenta?.razonSocial}">
                                </div>

                                <!-- CUIT -->
                                <div class="mb-3">
                                    <label for="cuit" class="form-label">
                                        <i class="fas fa-id-card me-2"></i>CUIT *
                                    </label>
                                    <input type="text" class="form-control" id="cuit" 
                                           name="cuit" required pattern="[0-9]{11}"
                                           placeholder="20123456789" maxlength="11"
                                           th:value="${cuenta?.cuit}">
                                    <small class="text-muted">Ingrese 11 dígitos numéricos sin guiones</small>
                                </div>

                                <!-- Condición Frente al IVA -->
                                <div class="mb-3">
                                    <label for="condicionFrenteIVA" class="form-label">
                                        <i class="fas fa-file-invoice me-2"></i>Condición Frente al IVA *
                                    </label>
                                    <select class="form-select" id="condicionFrenteIVA" 
                                            name="condicionFrenteIVA" required>
                                        <option value="">Seleccione una condición...</option>
                                        <option value="RESPONSABLE_INSCRIPTO" 
                                                th:selected="${cuenta?.condicionFrenteIVA?.name() == 'RESPONSABLE_INSCRIPTO'}">
                                            Responsable Inscripto
                                        </option>
                                        <option value="MONOTRIBUTISTA"
                                                th:selected="${cuenta?.condicionFrenteIVA?.name() == 'MONOTRIBUTISTA'}">
                                            Monotributista
                                        </option>
                                        <option value="EXENTO"
                                                th:selected="${cuenta?.condicionFrenteIVA?.name() == 'EXENTO'}">
                                            Exento
                                        </option>
                                        <option value="CONSUMIDOR_FINAL"
                                                th:selected="${cuenta?.condicionFrenteIVA?.name() == 'CONSUMIDOR_FINAL'}">
                                            Consumidor Final
                                        </option>
                                    </select>
                                </div>

                                <!-- Domicilio Fiscal -->
                                <div class="mb-3">
                                    <label for="domicilioFiscal" class="form-label">
                                        <i class="fas fa-map-marker-alt me-2"></i>Domicilio Fiscal *
                                    </label>
                                    <textarea class="form-control" id="domicilioFiscal" 
                                              name="domicilioFiscal" rows="2" required
                                              maxlength="200" style="resize: none;" 
                                              th:text="${cuenta?.domicilioFiscal}"></textarea>
                                </div>

                                <!-- Estado (solo en edición) -->
                                <div class="mb-3" th:if="${cuenta != null}">
                                    <label for="estado" class="form-label">
                                        <i class="fas fa-toggle-on me-2"></i>Estado
                                    </label>
                                    <select class="form-select" id="estado" name="estado">
                                        <option value="ACTIVO" 
                                                th:selected="${cuenta?.estado.name() == 'ACTIVO'}">
                                            ACTIVO
                                        </option>
                                        <option value="INACTIVO"
                                                th:selected="${cuenta?.estado.name() == 'INACTIVO'}">
                                            INACTIVO
                                        </option>
                                    </select>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Panel Lateral - Servicios -->
                <div class="col-lg-4">
                    <div class="card shadow-4 mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>Servicios
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Seleccione los servicios que desea asociar a esta cuenta:
                            </p>
                            
                            <div id="listaServicios" class="list-group">
                                <div th:each="servicio : ${servicios}" class="list-group-item">
                                    <div class="form-check">
                                        <input class="form-check-input servicio-checkbox" 
                                               type="checkbox" 
                                               th:id="'servicio_' + ${servicio.idServicio}"
                                               th:value="${servicio.idServicio}"
                                               th:checked="${cuenta != null && cuenta.serviciosDeLaCuenta != null && #lists.contains(cuenta.serviciosDeLaCuenta.![servicio.idServicio], servicio.idServicio)}">
                                        <label class="form-check-label w-100" 
                                               th:for="'servicio_' + ${servicio.idServicio}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <strong th:text="${servicio.nombreServicio}"></strong>
                                                    <br>
                                                    <small class="text-muted" 
                                                           th:text="${servicio.descripcionServicio}"></small>
                                                </div>
                                                <span class="badge bg-success" 
                                                      th:text="'$ ' + ${servicio.montoServicio}"></span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${servicios == null || #lists.isEmpty(servicios)}" 
                                 class="text-center py-3">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No hay servicios disponibles</p>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="card shadow-4">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-tools me-2"></i>Acciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="btnGuardar">
                                    <i class="fas fa-save me-2"></i>
                                    <span th:text="${cuenta != null ? 'Actualizar Cuenta' : 'Crear Cuenta'}"></span>
                                </button>
                                
                                <a th:href="@{/cuentas}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{fragments/template :: footer}"></footer>

    <!-- Modal para mensajes -->
    <div class="modal fade" id="modalMensaje" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="modalTitulo">
                        <i class="fas fa-info-circle me-2 text-info"></i>Información
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="modalCuerpo">Mensaje</p>
                    <div id="modalErrores" class="mt-3"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary" id="btnModalAceptar">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{fragments/template :: scripts}"></th:block>

    <script th:inline="javascript">
        const esEdicion = /*[[${cuenta != null}]]*/ false;
        const idCuentaActual = /*[[${cuenta?.idCuenta}]]*/ null;

        // Filtrar solo números en CUIT al escribir
        document.getElementById('cuit').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Función para mostrar modal
        function mostrarModal(titulo, mensaje, callback, errores = null) {
            const modal = document.getElementById('modalMensaje');
            document.getElementById('modalTitulo').innerHTML = titulo;
            document.getElementById('modalCuerpo').textContent = mensaje;
            
            const divErrores = document.getElementById('modalErrores');
            divErrores.innerHTML = '';
            
            if (errores && Object.keys(errores).length > 0) {
                const ulErrores = document.createElement('ul');
                ulErrores.className = 'list-unstyled text-danger small';
                
                for (const [campo, error] of Object.entries(errores)) {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i><strong>${campo}:</strong> ${error}`;
                    ulErrores.appendChild(li);
                }
                
                divErrores.appendChild(ulErrores);
            }
            
            const btnAceptar = document.getElementById('btnModalAceptar');
            btnAceptar.onclick = function() {
                bootstrap.Modal.getInstance(modal).hide();
                if (callback) callback();
            };
            
            new bootstrap.Modal(modal).show();
        }

        // Guardar cuenta
        document.getElementById('btnGuardar').addEventListener('click', async function() {
            const form = document.getElementById('formCuenta');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const cuentaData = {
                razonSocial: formData.get('razonSocial'),
                cuit: formData.get('cuit'),
                condicionFrenteIVA: formData.get('condicionFrenteIVA'),
                domicilioFiscal: formData.get('domicilioFiscal')
            };

            if (esEdicion) {
                cuentaData.estado = formData.get('estado');
            }

            const idCliente = formData.get('idCliente');

            try {
                // Guardar o actualizar cuenta
                let response;
                if (esEdicion) {
                    response = await fetch(`/cuentas/${idCuentaActual}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cuentaData)
                    });
                } else {
                    response = await fetch(`/cuentas/cliente/${idCliente}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cuentaData)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw {
                        status: response.status,
                        data: errorData
                    };
                }

                const cuenta = await response.json();
                const idCuenta = cuenta.idCuenta;

                // Obtener servicios seleccionados
                const checkboxes = document.querySelectorAll('.servicio-checkbox:checked');
                const serviciosSeleccionados = Array.from(checkboxes).map(cb => parseInt(cb.value));

                // Agregar servicios si hay seleccionados
                if (serviciosSeleccionados.length > 0) {
                    const params = new URLSearchParams();
                    serviciosSeleccionados.forEach(id => params.append('servicios', id));
                    
                    const serviciosResponse = await fetch(`/cuentas/${idCuenta}/servicios/multiple?${params}`, {
                        method: 'POST'
                    });

                    if (!serviciosResponse.ok) {
                        console.warn('Algunos servicios no pudieron agregarse');
                    }
                }

                mostrarModal(
                    '<i class="fas fa-check-circle me-2 text-success"></i>Éxito',
                    `Cuenta ${esEdicion ? 'actualizada' : 'creada'} exitosamente`,
                    () => window.location.href = '/cuentas'
                );

            } catch (error) {
                console.error('Error:', error);
                
                let titulo = '<i class="fas fa-exclamation-circle me-2 text-danger"></i>Error';
                let mensaje = 'Ocurrió un error al procesar la solicitud';
                let errores = null;

                if (error.data) {
                    if (error.data.errores) {
                        errores = error.data.errores;
                        mensaje = error.data.mensaje || 'Por favor, corrija los errores indicados';
                    } else if (error.data.detalle) {
                        mensaje = error.data.detalle;
                    } else if (error.data.mensaje) {
                        mensaje = error.data.mensaje;
                    }
                } else if (error.message) {
                    mensaje = error.message;
                }

                mostrarModal(titulo, mensaje, null, errores);
            }
        });
    </script>
</body>

</html>
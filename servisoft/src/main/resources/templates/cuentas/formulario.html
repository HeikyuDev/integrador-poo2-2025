<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/template :: head}"></head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<body class="d-flex flex-column min-vh-100">
    <header th:replace="~{fragments/template :: navbar}"></header>

    <main class="flex-fill">
        <div class="container my-5">
            <!-- Encabezado -->
            <div class="mb-4">
                <h2 class="fw-bold">
                    <i class="fas fa-wallet me-2 text-primary"></i>
                    <span th:text="${cuenta != null ? 'Editar Cuenta' : 'Nueva Cuenta'}"></span>
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/cuentas}">Cuentas</a></li>
                        <li class="breadcrumb-item active" th:text="${cuenta != null ? 'Editar' : 'Nueva'}"></li>
                    </ol>
                </nav>
            </div>

            <!-- Formulario -->
            <div class="card shadow-4">
                <div class="card-body">
                    <form id="formCuenta">
                        <div class="row">
                            <!-- Cliente -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user me-2"></i>Cliente *
                                </label>
                                <select class="form-select" id="idCliente" required 
                                        th:disabled="${cuenta != null}"
                                        data-allow-clear="true"
                                        data-placeholder="Buscar cliente por nombre o tipo...">
                                    <option value="">Seleccione un cliente</option>
                                    <option th:each="cliente : ${clientes}" 
                                            th:value="${cliente.idCliente}"
                                            th:text="${cliente.nombre + ' (' + cliente.tipoCliente + ')'}"
                                            th:selected="${cuenta?.cliente?.idCliente == cliente.idCliente}">
                                    </option>
                                </select>
                                <div class="form-text" th:if="${cuenta != null}">
                                    El cliente no puede modificarse una vez creada la cuenta
                                </div>
                            </div>

                            <!-- Razón Social -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-building me-2"></i>Razón Social *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="razonSocial" 
                                       maxlength="50" 
                                       required
                                       th:value="${cuenta != null ? cuenta.razonSocial : ''}">
                            </div>

                            <!-- CUIT -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-id-card me-2"></i>CUIT *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="cuit" 
                                       maxlength="11" 
                                       pattern="[0-9]{11}"
                                       placeholder="20123456789"
                                       required
                                       th:value="${cuenta != null ? cuenta.cuit : ''}">
                                <div class="form-text">Ingrese 11 dígitos numéricos sin guiones</div>
                            </div>

                            <!-- Condición Frente al IVA -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-file-invoice me-2"></i>Condición Frente al IVA *
                                </label>
                                <select class="form-select" id="condicionFrenteIVA" required>
                                    <option value="">Seleccione una condición</option>
                                    <option value="RESPONSABLE_INSCRIPTO" 
                                            th:selected="${cuenta != null && cuenta.condicionFrenteIVA.name() == 'RESPONSABLE_INSCRIPTO'}">
                                        Responsable Inscripto
                                    </option>
                                    <option value="MONOTRIBUTISTA"
                                            th:selected="${cuenta != null && cuenta.condicionFrenteIVA.name() == 'MONOTRIBUTISTA'}">
                                        Monotributista
                                    </option>
                                    <option value="EXENTO"
                                            th:selected="${cuenta != null && cuenta.condicionFrenteIVA.name() == 'EXENTO'}">
                                        Exento
                                    </option>
                                    <option value="CONSUMIDOR_FINAL"
                                            th:selected="${cuenta != null && cuenta.condicionFrenteIVA.name() == 'CONSUMIDOR_FINAL'}">
                                        Consumidor Final
                                    </option>
                                </select>
                            </div>

                            <!-- Domicilio Fiscal -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt me-2"></i>Domicilio Fiscal *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="domicilioFiscal" 
                                       maxlength="50" 
                                       required
                                       th:value="${cuenta != null ? cuenta.domicilioFiscal : ''}">
                            </div>

                            <!-- Estado (solo en edición) -->
                            <div class="col-md-6 mb-4" th:if="${cuenta != null}">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-toggle-on me-2"></i>Estado *
                                </label>
                                <select class="form-select" id="estado" required>
                                    <option value="ACTIVO" th:selected="${cuenta.estado.name() == 'ACTIVO'}">
                                        Activo
                                    </option>
                                    <option value="SUSPENDIDO" th:selected="${cuenta.estado.name() == 'SUSPENDIDO'}">
                                        Suspendido
                                    </option>
                                    <option value="INACTIVO" th:selected="${cuenta.estado.name() == 'INACTIVO'}">
                                        Inactivo
                                    </option>
                                </select>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a th:href="@{/cuentas}" class="btn btn-secondary" data-mdb-ripple-init>
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </a>
                            <button type="submit" class="btn btn-primary" data-mdb-ripple-init>
                                <i class="fas fa-save me-2"></i>Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para mensajes -->
    <div class="modal fade" id="modalMensaje" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="modalTitulo">
                        <i class="fas fa-check-circle me-2 text-success"></i>Éxito
                    </h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p id="modalCuerpo">La operación se completó exitosamente.</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary" data-mdb-dismiss="modal" id="btnModalAceptar">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Select2 CSS para búsqueda en select de clientes -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-5-theme/1.3.0/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

    <!-- jQuery (requerido por Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>

    <script th:inline="javascript">
        const esEdicion = /*[[${cuenta != null}]]*/ false;
        const idCuentaEditar = /*[[${cuenta != null ? cuenta.idCuenta : 0}]]*/ 0;

        // Función para mostrar modal de éxito
        function mostrarModalExito(mensaje, redirigir = false) {
            const modal = document.getElementById('modalMensaje');
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-check-circle me-2 text-success"></i>Éxito';
            document.getElementById('modalCuerpo').textContent = mensaje;
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            if (redirigir) {
                document.getElementById('btnModalAceptar').onclick = function() {
                    window.location.href = '/cuentas';
                };
            }
        }

        // Función para mostrar modal de error
        function mostrarModalError(mensaje) {
            const modal = document.getElementById('modalMensaje');
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-exclamation-circle me-2 text-danger"></i>Error';
            document.getElementById('modalCuerpo').textContent = mensaje;
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Función para mostrar modal de validación
        function mostrarModalValidacion(mensaje) {
            const modal = document.getElementById('modalMensaje');
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-info-circle me-2 text-warning"></i>Validación';
            document.getElementById('modalCuerpo').textContent = mensaje;
            
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Inicializar Select2 para el campo de clientes con búsqueda
        $(document).ready(function() {
            $('#idCliente').select2({
                placeholder: 'Buscar y seleccionar cliente...',
                theme: 'bootstrap-5',
                width: '100%',
                allowClear: !esEdicion,
                language: 'es' // Si tienes traducción, o usa la predeterminada en inglés
            });

            // Forzar que CondicionFrenteIVA sea selección única (validación adicional)
            $('#condicionFrenteIVA').on('change', function() {
                const seleccionadas = $(this).val();
                if (Array.isArray(seleccionadas) && seleccionadas.length > 1) {
                    // Si por alguna razón se selecciona más de una, mantener solo la primera
                    $(this).val([seleccionadas[0]]).trigger('change');
                }
            });
        });

        document.getElementById('formCuenta').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validar que se haya seleccionado una condición frente al IVA
            const condicionFrenteIVA = document.getElementById('condicionFrenteIVA').value;
            if (!condicionFrenteIVA) {
                mostrarModalValidacion('Debe seleccionar una Condición Frente al IVA');
                return;
            }

            const datos = {
                razonSocial: document.getElementById('razonSocial').value,
                cuit: document.getElementById('cuit').value,
                condicionFrenteIVA: condicionFrenteIVA,
                domicilioFiscal: document.getElementById('domicilioFiscal').value
            };

            if (esEdicion) {
                datos.estado = document.getElementById('estado').value;
            }

            try {
                let url, metodo;
                
                if (esEdicion) {
                    url = `/cuentas/${idCuentaEditar}`;
                    metodo = 'PUT';
                } else {
                    const idCliente = document.getElementById('idCliente').value;
                    if (!idCliente) {
                        mostrarModalValidacion('Debe seleccionar un cliente');
                        return;
                    }
                    url = `/cuentas/cliente/${idCliente}`;
                    metodo = 'POST';
                }

                console.log('Enviando solicitud:', metodo, url, datos);

                const response = await fetch(url, {
                    method: metodo,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datos)
                });

                if (response.ok) {
                    const mensaje = esEdicion ? 'Cuenta actualizada exitosamente' : 'Cuenta creada exitosamente';
                    mostrarModalExito(mensaje, true);
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', response.status, errorText);
                    mostrarModalError('Error: ' + (errorText || 'No se pudo guardar la cuenta'));
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarModalError('Error al procesar la solicitud: ' + error.message);
            }
        });

        // Validación en tiempo real del CUIT
        document.getElementById('cuit').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>

</html>